# 手動対応ガイド

本番運用に向けて手動で対応が必要な項目を優先度順にまとめています。

## 最優先（本番運用に必須）

### 1. 環境変数の設定（Vercel）

**作業内容:**
1. Vercelダッシュボードにログイン
2. プロジェクトを選択 > Settings > Environment Variables
3. 以下の環境変数を追加（Production環境に設定）

**必須環境変数:**
```
COOKIE_SIGNATURE_KEY_1=<32文字以上のランダム文字列>
COOKIE_SIGNATURE_KEY_2=<32文字以上のランダム文字列>
FIREBASE_PROJECT_ID=sirius-cf574
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@sirius-cf574.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyCyjOZ0BLsVrq49-O_ihwMq1kO9ZO_Aoeg
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=sirius-cf574.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=sirius-cf574
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=sirius-cf574.firebasestorage.app
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=753671151982
NEXT_PUBLIC_FIREBASE_APP_ID=1:753671151982:web:457a1dd3d208b39b1ca17f
```

**重要:**
- `COOKIE_SIGNATURE_KEY_1`と`COOKIE_SIGNATURE_KEY_2`は必ずランダムな文字列（32文字以上）に変更
- `FIREBASE_PRIVATE_KEY`は改行文字`\n`を含むため、そのまま貼り付け
- `FIREBASE_CLIENT_EMAIL`はFirebase Console > プロジェクト設定 > サービスアカウントから取得

**参考:** `VERCEL_ENV_VARS.md`に詳細あり

### 2. Firebaseセキュリティルールのデプロイ

**作業内容:**
1. Firebase CLIをインストール（未インストールの場合）
   ```bash
   npm install -g firebase-tools
   ```
2. Firebaseにログイン
   ```bash
   firebase login
   ```
3. プロジェクトを初期化（未初期化の場合）
   ```bash
   firebase init firestore
   firebase init storage
   ```
4. セキュリティルールをデプロイ
   ```bash
   firebase deploy --only firestore:rules
   firebase deploy --only storage:rules
   ```

**確認:**
- Firebase Console > Firestore Database > ルール で確認
- Firebase Console > Storage > ルール で確認

### 3. Firebase Service Accountの設定

**作業内容:**
1. Firebase Console > プロジェクト設定 > サービスアカウント
2. 「新しい秘密鍵の生成」をクリック
3. JSONファイルをダウンロード
4. 以下の情報をVercel環境変数に設定:
   - `FIREBASE_PROJECT_ID`: JSONの`project_id`
   - `FIREBASE_CLIENT_EMAIL`: JSONの`client_email`
   - `FIREBASE_PRIVATE_KEY`: JSONの`private_key`（改行文字`\n`を含む）

### 4. ビルドエラーの確認

**作業内容:**
```bash
npm run build
```

**確認項目:**
- ビルドが成功するか
- TypeScriptエラーがないか
- リンターエラーがないか

エラーがある場合は修正してからデプロイ。

### 5. Vercelへのデプロイ

**作業内容:**
1. VercelにGitHubリポジトリを接続
2. プロジェクト設定を確認
3. デプロイを実行
4. デプロイ後の動作確認

## 高優先度（本番運用前に推奨）

### 6. 本番環境での動作確認

**確認項目:**
- [ ] ログイン機能が正常に動作するか
- [ ] プロジェクト作成・編集が正常に動作するか
- [ ] ドキュメントアップロードが正常に動作するか
- [ ] ユーザー管理（admin機能）が正常に動作するか

### 7. 初期データの準備

**作業内容:**
1. 管理者アカウントの作成
   - Firebase Authenticationでメールアドレス/パスワードでユーザーを作成
   - Firestoreの`users`コレクションに管理者レコードを追加（role: 'admin'）
2. サンプルデータの投入（必要に応じて）
   ```bash
   npm run seed
   ```

### 8. Cookie設定の確認

**確認内容:**
- `src/auth/config.ts`の`cookieSerializeOptions`で`secure: process.env.NODE_ENV === "production"`が設定されていることを確認
- 本番環境（`NODE_ENV=production`）では`secure: true`が有効になる

### 9. HTTPSの強制確認

**確認内容:**
- Vercelは自動的にHTTPSを強制するため、追加設定は不要
- カスタムドメインを使用する場合、SSL証明書が自動的に設定されることを確認

## 中優先度（運用開始後に対応可能）

### 10. Firebase Authenticationの設定確認

**確認項目:**
- Firebase Console > Authentication > 設定
- メール/パスワード認証が有効になっているか
- 必要に応じて、許可するメールドメインの制限を設定
- パスワードポリシーの設定（必要に応じて）

### 11. Firestoreインデックスの作成

**確認内容:**
現在のクエリは単一フィールドの`orderBy`のみ使用しているため、複合インデックスは不要。
ただし、将来的に複合クエリを追加する場合は、Firebase Consoleでエラーメッセージに従ってインデックスを作成。

**現在使用しているクエリ:**
- `projects/{projectId}/documents`: `orderBy("createdAt", "asc")` - インデックス不要

### 12. データバックアップ設定

**作業内容:**
1. Firebase Console > Firestore Database > バックアップ
2. 自動バックアップを有効化
3. バックアップスケジュールを設定
4. バックアップからの復旧手順を確認・文書化

### 13. エラー監視ツールの導入（推奨）

**推奨ツール:**
- Sentry
- Vercel Analytics

**作業内容:**
1. Sentryアカウントを作成
2. Next.jsプロジェクトにSentryを統合
3. エラー通知を設定

## 低優先度（必要に応じて）

### 14. テスト

**機能テスト:**
- 主要機能の動作確認
- エッジケースのテスト

**ブラウザ互換性テスト:**
- Chrome, Firefox, Safari, Edgeでの動作確認

**モバイル対応確認:**
- レスポンシブデザインの確認
- タッチ操作の確認

### 15. ドキュメント整備

- デプロイ手順の文書化
- トラブルシューティングガイドの作成
- アーキテクチャ図の作成（必要に応じて）

### 16. 型安全性の確認

**確認内容:**
- `tsconfig.json`で`strict: true`が設定されていることを確認（既に設定済み）
- 型エラーがないことを確認（`npm run build`で確認）

### 17. 依存関係の更新

**作業内容:**
```bash
npm outdated
npm update
```

セキュリティアップデートがある場合は優先的に更新。

## チェックリスト更新

各項目を完了したら、`doc/本番運用チェックリスト.md`の該当項目にチェックを入れてください。

