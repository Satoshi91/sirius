# ゲストログイン問題のトラブルシューティング

Vercel staging環境でゲストログインが失敗する場合の確認手順です。

## 1. Vercel環境変数の確認

### 方法1: Vercel CLIで確認

```powershell
# すべての環境変数を表示
vercel env ls

# Preview環境の環境変数を確認
vercel env ls | Select-String "preview"

# 特定の環境変数を確認（例: FIREBASE_PROJECT_ID）
vercel env ls | Select-String "FIREBASE_PROJECT_ID"
```

### 方法2: Vercelダッシュボードで確認

1. [Vercel Dashboard](https://vercel.com/dashboard) にログイン
2. プロジェクトを選択
3. **Settings** > **Environment Variables** に移動
4. **Preview** 環境の環境変数を確認

### 必須環境変数（Preview環境に設定されているか確認）

- `FIREBASE_PROJECT_ID` - FirebaseプロジェクトID
- `FIREBASE_CLIENT_EMAIL` - Firebase Service Accountのメールアドレス
- `FIREBASE_PRIVATE_KEY` - Firebase Service Accountの秘密鍵（改行文字含む）

## 2. Vercelログの確認

### 方法1: Vercelダッシュボードで確認

1. Vercel Dashboard > プロジェクト > **Deployments** に移動
2. 該当するデプロイメントを選択
3. **Functions** タブを開く
4. ゲストログインを実行した時刻のログを確認
5. `[handleGuestLogin]` で始まるログを探す

### 確認すべきログ

- `[handleGuestLogin] Environment check:` - 環境変数の値
- `[handleGuestLogin] Firebase Admin SDK initialized successfully` - Firebase Admin SDKの初期化成功
- `[handleGuestLogin] Error handling guest login:` - エラーの詳細

## 3. よくある問題と解決方法

### 問題1: 環境変数が設定されていない

**症状:**

- ログに `FIREBASE_PROJECT_ID: ✗ Missing` などが表示される

**解決方法:**

```powershell
# Preview環境に環境変数を設定
.\scripts\set-vercel-env-auto.ps1
# または
vercel env add FIREBASE_PROJECT_ID preview
```

### 問題2: FIREBASE_PRIVATE_KEYの改行文字の問題

**症状:**

- Firebase Admin SDKの初期化エラー
- `Error: Invalid private key` などのエラー

**解決方法:**

```powershell
# 既存の環境変数を削除
vercel env rm FIREBASE_PRIVATE_KEY preview --yes

# .env.localから値を読み込んで再設定
$privateKey = Get-Content .env.local | Where-Object { $_ -match "^FIREBASE_PRIVATE_KEY=" } | ForEach-Object { $_ -replace "^FIREBASE_PRIVATE_KEY=", "" } | ForEach-Object { $_ -replace '^"', '' -replace '"$', '' } | ForEach-Object { $_ -replace '\\n', "`n" }
$privateKey | vercel env add FIREBASE_PRIVATE_KEY preview
```

### 問題3: 環境判定が正しく動作していない

**症状:**

- ログに `isProduction: true` と表示される
- `VERCEL_ENV` が正しく設定されていない

**確認方法:**
ログの `[handleGuestLogin] Environment check:` を確認：

- `VERCEL_ENV` が `preview` になっているか
- `NODE_ENV` が `production` でも、`VERCEL_ENV` が `preview` ならゲストログインは有効

## 4. デバッグ用のログ出力

修正後のコードでは、以下のログが出力されます：

1. **環境チェック:**

   ```
   [handleGuestLogin] Environment check: {
     NODE_ENV: "production",
     VERCEL_ENV: "preview",
     NEXT_PUBLIC_VERCEL_ENV: "preview",
     vercelEnv: "preview",
     isProduction: false
   }
   ```

2. **Firebase Admin SDK初期化:**

   ```
   [handleGuestLogin] Initializing Firebase Admin SDK...
   [handleGuestLogin] Firebase Admin SDK initialized successfully
   ```

3. **エラー発生時:**
   ```
   [handleGuestLogin] Error handling guest login: [エラー詳細]
   [handleGuestLogin] Error message: [エラーメッセージ]
   [handleGuestLogin] Environment variables: {
     FIREBASE_PROJECT_ID: "✓ Set" or "✗ Missing",
     FIREBASE_CLIENT_EMAIL: "✓ Set" or "✗ Missing",
     FIREBASE_PRIVATE_KEY: "✓ Set" or "✗ Missing"
   }
   ```

## 5. 再デプロイ後の確認

環境変数を設定・修正した後は、**必ず再デプロイ**が必要です：

1. Vercel Dashboard > プロジェクト > **Deployments**
2. 最新のデプロイメントの **...** メニューから **Redeploy** を選択
3. または、新しいコミットをプッシュして自動デプロイをトリガー

## 6. 確認チェックリスト

- [ ] Preview環境に `FIREBASE_PROJECT_ID` が設定されている
- [ ] Preview環境に `FIREBASE_CLIENT_EMAIL` が設定されている
- [ ] Preview環境に `FIREBASE_PRIVATE_KEY` が設定されている（改行文字含む）
- [ ] 環境変数設定後に再デプロイを実行した
- [ ] Vercelログで `[handleGuestLogin]` のログを確認した
- [ ] エラーメッセージの内容を確認した
