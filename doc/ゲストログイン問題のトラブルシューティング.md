# ゲストログイン問題のトラブルシューティング

Vercel staging環境でゲストログインが失敗する場合の確認手順です。

## 概要

ゲストログインは、Firebase Authenticationのメールアドレス認証を使用しています。
固定メールアドレス（`s.t.n.uytrewq+guest@gmail.com`）と環境変数で設定したパスワードでログインします。

## 1. Firebase Consoleでの設定確認

### 1.1 メールアドレス認証の有効化

1. [Firebase Console](https://console.firebase.google.com/) にログイン
2. プロジェクトを選択
3. **Authentication** > **Sign-in method** タブに移動
4. **メール/パスワード** が有効になっているか確認
5. 無効の場合は有効化する

### 1.2 ゲストユーザーの作成

1. Firebase Console > **Authentication** > **Users** タブに移動
2. メールアドレス `s.t.n.uytrewq+guest@gmail.com` のユーザーが存在するか確認
3. 存在しない場合は、**ユーザーを追加** をクリック
4. 以下の情報を入力：
   - メールアドレス: `s.t.n.uytrewq+guest@gmail.com`
   - パスワード: 任意（環境変数 `NEXT_PUBLIC_GUEST_PASSWORD` と同じ値に設定）
5. ユーザーを作成

## 2. Vercel環境変数の確認

### 方法1: Vercel CLIで確認

```powershell
# すべての環境変数を表示
vercel env ls

# Preview環境の環境変数を確認
vercel env ls | Select-String "preview"

# 特定の環境変数を確認（例: NEXT_PUBLIC_GUEST_PASSWORD）
vercel env ls | Select-String "NEXT_PUBLIC_GUEST_PASSWORD"
```

### 方法2: Vercelダッシュボードで確認

1. [Vercel Dashboard](https://vercel.com/dashboard) にログイン
2. プロジェクトを選択
3. **Settings** > **Environment Variables** に移動
4. **Preview** 環境の環境変数を確認

### 必須環境変数（Preview環境に設定されているか確認）

- `NEXT_PUBLIC_GUEST_PASSWORD` - ゲストログイン用パスワード（Firebase Consoleで設定したパスワードと同じ値）

## 3. よくある問題と解決方法

### 問題1: 環境変数が設定されていない

**症状:**

- エラーメッセージ: "ゲストログインのパスワードが設定されていません"

**解決方法:**

1. `.env.local` に `NEXT_PUBLIC_GUEST_PASSWORD` を追加
2. Vercel環境変数に設定：

```powershell
vercel env add NEXT_PUBLIC_GUEST_PASSWORD preview
# パスワードを入力（Firebase Consoleで設定したパスワードと同じ値）
```

3. 再デプロイを実行

### 問題2: パスワードが一致しない

**症状:**

- エラーメッセージ: "パスワードが間違っています。環境変数を確認してください。"
- エラーコード: `auth/wrong-password`

**解決方法:**

1. Firebase Consoleで `s.t.n.uytrewq+guest@gmail.com` のパスワードを確認
2. 環境変数 `NEXT_PUBLIC_GUEST_PASSWORD` が同じ値になっているか確認
3. 異なる場合は、環境変数を更新するか、Firebase Consoleでパスワードをリセット

### 問題3: ゲストユーザーが存在しない

**症状:**

- エラーメッセージ: "ゲストユーザーが存在しません。Firebase Consoleでユーザーを作成してください。"
- エラーコード: `auth/user-not-found`

**解決方法:**

1. Firebase Console > **Authentication** > **Users** タブに移動
2. メールアドレス `s.t.n.uytrewq+guest@gmail.com` のユーザーが存在するか確認
3. 存在しない場合は、**ユーザーを追加** で作成
4. パスワードは環境変数 `NEXT_PUBLIC_GUEST_PASSWORD` と同じ値に設定

### 問題4: メールアドレス認証が無効

**症状:**

- エラーメッセージ: 認証方法が無効である旨のエラー

**解決方法:**

1. Firebase Console > **Authentication** > **Sign-in method** タブ
2. **メール/パスワード** が有効になっているか確認
3. 無効の場合は有効化する

### 問題5: ユーザーが無効化されている

**症状:**

- エラーメッセージ: "このアカウントは無効化されています。"
- エラーコード: `auth/user-disabled`

**解決方法:**

1. Firebase Console > **Authentication** > **Users** タブ
2. `s.t.n.uytrewq+guest@gmail.com` のユーザーを選択
3. ユーザーが無効化されていないか確認
4. Firestoreの `users` コレクションで `isActive` が `true` になっているか確認

## 4. デバッグ用のログ出力

ブラウザのコンソールで以下のログを確認できます：

1. **パスワード未設定エラー:**

   ```
   [handleGuestSignIn] Error message: ゲストログインのパスワードが設定されていません
   ```

2. **認証エラー:**
   ```
   [handleGuestSignIn] Error code: auth/wrong-password
   [handleGuestSignIn] Error message: [エラーメッセージ]
   ```

## 5. 再デプロイ後の確認

環境変数を設定・修正した後は、**必ず再デプロイ**が必要です：

1. Vercel Dashboard > プロジェクト > **Deployments**
2. 最新のデプロイメントの **...** メニューから **Redeploy** を選択
3. または、新しいコミットをプッシュして自動デプロイをトリガー

## 6. 確認チェックリスト

- [ ] Firebase Consoleでメールアドレス認証が有効になっている
- [ ] Firebase Consoleで `s.t.n.uytrewq+guest@gmail.com` のユーザーが存在する
- [ ] 環境変数 `NEXT_PUBLIC_GUEST_PASSWORD` が設定されている（Preview環境）
- [ ] 環境変数のパスワードがFirebase Consoleのパスワードと同じ
- [ ] 環境変数設定後に再デプロイを実行した
- [ ] ブラウザのコンソールでエラーログを確認した

## 7. よくあるエラーパターンと対処法

### `auth/wrong-password`

**意味:** パスワードが間違っている

**対処法:** Firebase Consoleのパスワードと環境変数 `NEXT_PUBLIC_GUEST_PASSWORD` が一致しているか確認してください。

### `auth/user-not-found`

**意味:** ゲストユーザーが存在しない

**対処法:** Firebase Consoleで `s.t.n.uytrewq+guest@gmail.com` のユーザーを作成してください。

### `auth/invalid-email`

**意味:** メールアドレスの形式が正しくない

**対処法:** コード内で使用しているメールアドレス（`s.t.n.uytrewq+guest@gmail.com`）が正しいか確認してください。

### `auth/user-disabled`

**意味:** ユーザーアカウントが無効化されている

**対処法:** Firebase Consoleでユーザーが有効になっているか、Firestoreの `users` コレクションで `isActive` が `true` になっているか確認してください。
