# 環境変数設定ガイド

このドキュメントでは、Vercel環境変数を安全に設定するためのベストプラクティスを説明します。

## 重要な注意事項

### 改行文字の問題

環境変数に改行文字（`\r\n`、`\n`、`\r`）が含まれていると、以下のような問題が発生する可能性があります：

- Firebaseの`authDomain`に改行が含まれると、URLエラー（`Illegal url for new iframe`）が発生
- 環境変数の値が意図しない文字列になる
- アプリケーションの動作が不安定になる

### 改行文字が混入する原因

1. **Vercelダッシュボードでのコピー&ペースト**
   - テキストをコピーする際に改行が含まれる
   - 値の前後にスペースや改行が入る

2. **PowerShellの`echo`コマンド**
   - `echo`コマンドはデフォルトで改行を追加する可能性がある
   - パイプで渡す際に改行が含まれる

3. **`.env.local`ファイルの行末**
   - ファイルの行末に改行文字が含まれている
   - Windows環境では`\r\n`（CRLF）が使用される

## 推奨される設定方法

### 方法1: 自動設定スクリプトを使用（推奨）

最も安全な方法は、提供されている自動設定スクリプトを使用することです：

```powershell
# Windows (PowerShell)
.\scripts\set-vercel-env-auto.ps1
```

このスクリプトは：
- `.env.local`から環境変数を読み込む
- 改行文字を自動的に削除する（`FIREBASE_PRIVATE_KEY`は除く）
- すべての環境に一括設定できる

### 方法2: 手動でVercel CLIを使用

手動で設定する場合、以下の方法を使用してください：

```powershell
# 変数に値を設定してからパイプで渡す（改行を避ける）
$value = "sirius-cf574.firebaseapp.com"
$value | vercel env add NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN production
```

**避けるべき方法**:
```powershell
# ❌ 避ける: echoコマンドは改行を追加する可能性がある
echo "sirius-cf574.firebaseapp.com" | vercel env add NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN production
```

### 方法3: Vercelダッシュボードから設定

Vercelダッシュボードから設定する場合：

1. **Settings** > **Environment Variables** に移動
2. 環境変数を追加する際、値の前後にスペースや改行が含まれていないか確認
3. コピー&ペーストする際は、テキストエディタで改行を確認してから貼り付ける

## 環境変数の確認方法

設定した環境変数を確認する：

```powershell
# すべての環境変数を表示
vercel env ls

# 特定の環境変数を表示
vercel env ls | Select-String "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"
```

## 問題が発生した場合の対処法

### 改行文字が含まれている場合

1. **既存の値を削除**:
```powershell
vercel env rm NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN production --yes
vercel env rm NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN preview --yes
vercel env rm NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN development --yes
```

2. **新しい値を設定**（改行文字なし）:
```powershell
$value = "sirius-cf574.firebaseapp.com"
$value | vercel env add NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN production
$value | vercel env add NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN preview
$value | vercel env add NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN development
```

3. **再デプロイ**: Vercelで再デプロイして変更を反映

### コード側での防御的プログラミング

コード側でも環境変数の値を正規化することで、改行文字の問題を防げます：

```typescript
// lib/firebase.ts
const firebaseConfig = {
  authDomain: (process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || "sirius-cf574.firebaseapp.com").trim(),
  // ... 他の設定
};
```

**注意**: `FIREBASE_PRIVATE_KEY`は改行文字を含む必要があるため、`.trim()`を適用しないでください。

## チェックリスト

環境変数を設定する前に、以下を確認してください：

- [ ] 値の前後にスペースや改行が含まれていない
- [ ] `FIREBASE_PRIVATE_KEY`以外の環境変数に改行が含まれていない
- [ ] 設定後、`vercel env ls`で値を確認した
- [ ] 再デプロイ後に動作を確認した

## 関連ドキュメント

- `VERCEL_ENV_COMMANDS.md` - 環境変数設定コマンド一覧
- `VERCEL_ENV_SETUP.md` - 環境変数設定方法の詳細
- `scripts/set-vercel-env-auto.ps1` - 自動設定スクリプト

